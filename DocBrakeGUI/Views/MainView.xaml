<UserControl x:Class="DocBrake.Views.MainView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
             xmlns:views="clr-namespace:DocBrake.Views"
             xmlns:mediaBrowser="clr-namespace:DocBrake.MediaBrowser.Views"
             xmlns:converters="clr-namespace:DocBrake.Converters"
             AllowDrop="True"
             PreviewDragOver="MainView_PreviewDragOver"
             DragEnter="MainView_DragEnter"
             DragLeave="MainView_DragLeave"
             Drop="MainView_Drop"
             Background="{DynamicResource WindowBrush}">

    <UserControl.Resources>
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter" />
        <converters:InverseBoolToVisibilityConverter x:Key="InverseBoolToVisibilityConverter" />
        <converters:StringNotEmptyConverter x:Key="StringNotEmptyConverter" />
        <converters:FileTypeToIconConverter x:Key="FileTypeToIconConverter" />
        <converters:DocumentStatusToColorConverter x:Key="DocumentStatusToColorConverter" />
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!-- Drag-and-Drop Overlay -->
        <Border x:Name="DragDropOverlay"
                Grid.RowSpan="2"
                Background="#CC1E88E5"
                BorderBrush="#1E88E5"
                BorderThickness="4"
                CornerRadius="8"
                Visibility="Collapsed"
                IsHitTestVisible="False"
                Margin="12">
            <Grid>
                <Viewbox Width="200" Height="200">
                    <Grid>
                        <!-- Dashed circle -->
                        <Ellipse Stroke="White" StrokeThickness="8" StrokeDashArray="20,10" Width="200" Height="200" />

                        <!-- Icon -->
                        <Path Data="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z"
                              Fill="White"
                              Stretch="Uniform"
                              Width="80"
                              Height="80"
                              HorizontalAlignment="Center"
                              VerticalAlignment="Center"/>
                    </Grid>
                </Viewbox>

                <TextBlock Text="Drop files here to add to queue"
                           FontSize="28"
                           FontWeight="SemiBold"
                           Foreground="White"
                           HorizontalAlignment="Center"
                           VerticalAlignment="Bottom"
                           Margin="0,0,0,80"/>
            </Grid>
        </Border>

        <!-- Main Content Area (Archive | Splitter | Content) -->
        <DockPanel Grid.Row="0">
            <!-- Archive Browser Panel (Left Side) - Only shown when archives exist -->
            <Border DockPanel.Dock="Left"
                    Width="280"
                    Background="{DynamicResource ControlBrush}"
                    Visibility="{Binding ArchiveTrackingViewModel.HasArchives, Converter={StaticResource BoolToVisibilityConverter}}">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <!-- Archive Header -->
                    <Border Grid.Row="0" Padding="12,10"
                            BorderBrush="{DynamicResource ActiveBorderBrush}"
                            BorderThickness="0,0,0,1">
                        <TextBlock Text="Archive Browser" FontSize="13" FontWeight="SemiBold" VerticalAlignment="Center"/>
                    </Border>

                    <!-- Archive Content -->
                    <views:ArchiveBrowserView Grid.Row="1" DataContext="{Binding ArchiveTrackingViewModel}"/>
                </Grid>
            </Border>

            <!-- GridSplitter between Archive and Content -->
            <GridSplitter DockPanel.Dock="Left"
                          Width="4"
                          HorizontalAlignment="Center"
                          VerticalAlignment="Stretch"
                          Background="{DynamicResource ActiveBorderBrush}"
                          ResizeBehavior="PreviousAndNext"
                          Cursor="SizeWE"
                          Visibility="{Binding ArchiveTrackingViewModel.HasArchives, Converter={StaticResource BoolToVisibilityConverter}}"/>

            <!-- Main Content (Center) - Takes remaining space -->
            <Grid Margin="8,0,0,0">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>

                <Menu Grid.Row="0">
                    <MenuItem Header="_File">
                        <MenuItem Header="_Settings..." Command="{Binding ShowSettingsCommand}" />
                    </MenuItem>
                    <MenuItem Header="_View" />
                    <MenuItem Header="_Help" />
                </Menu>

                <!-- Mode View Content -->
                <Grid Grid.Row="1">
                    <!-- Media Browser Mode with Preview Pane -->
                    <Grid Visibility="{Binding IsMediaBrowserMode, Converter={StaticResource BoolToVisibilityConverter}}">
                        <mediaBrowser:MediaBrowserView x:Name="MediaBrowserView"
                                                       DataContext="{Binding MediaBrowserViewModel}"/>
                    </Grid>
                </Grid>
            </Grid>
        </DockPanel>

        <!-- Bottom Bar (Status + Actions) -->
        <Border Grid.Row="1" Background="{DynamicResource ControlBrush}"
                BorderBrush="{DynamicResource ActiveBorderBrush}"
                BorderThickness="0,1,0,0" Padding="12,7">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>

                <!-- Progress Bar (visible during processing) -->
                <Grid Grid.Row="0" Margin="0,0,0,5"
                      Visibility="{Binding IsProcessing, Converter={StaticResource BoolToVisibilityConverter}}">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>
                    <ProgressBar Grid.Column="0" Value="{Binding OverallProgress, Mode=OneWay}"
                                 Minimum="0" Maximum="100" Height="16" />
                    <TextBlock Grid.Column="1" Text="{Binding ProgressText}"
                               VerticalAlignment="Center" Margin="8,0,0,0" FontWeight="Bold" FontSize="11" />
                </Grid>

                <!-- Status + Buttons Row -->
                <Grid Grid.Row="1">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>

                    <!-- Status Message -->
                    <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                        <TextBlock VerticalAlignment="Center" FontSize="11">
                            <TextBlock.Style>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Foreground" Value="{DynamicResource WindowTextBrush}"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsErrorState}" Value="True">
                                            <Setter Property="Foreground" Value="#FFD34545"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                            <Run Text="{Binding StatusMessage, Mode=OneWay}"/>
                        </TextBlock>
                        <TextBlock Text="{Binding CurrentFileName}" FontStyle="Italic" FontSize="11"
                                   Foreground="{DynamicResource GrayTextBrush}" Margin="8,0,0,0"
                                   Visibility="{Binding IsProcessing, Converter={StaticResource BoolToVisibilityConverter}}"/>
                        <TextBlock Text="{Binding EstimatedTimeRemaining}" FontWeight="SemiBold" FontSize="11"
                                   Foreground="{DynamicResource AccentColorBrush}" Margin="12,0,0,0"
                                   Visibility="{Binding IsProcessing, Converter={StaticResource BoolToVisibilityConverter}}"/>
                    </StackPanel>

                    <!-- Action Buttons -->
                    <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center">
                        <ui:Button Content="Test Encode" Appearance="Secondary"
                                   Command="{Binding TestEncodeCommand}" Margin="0,0,6,0" Padding="10,5" FontSize="11" />
                        <ui:Button Content="Extract" Appearance="Secondary"
                                   Command="{Binding ExtractArchiveCommand}" Margin="0,0,6,0" Padding="10,5" FontSize="11" />
                        <ui:Button Content="List" Appearance="Secondary"
                                   Command="{Binding ListArchiveCommand}" Margin="0,0,6,0" Padding="10,5" FontSize="11" />
                        <ui:Button Content="Process" Appearance="Primary"
                                   Command="{Binding StartProcessingCommand}" Margin="6,0,0,0" Padding="20,12" FontSize="12" FontWeight="SemiBold" />
                        <ui:Button Content="Cancel" Appearance="Secondary"
                                   Command="{Binding CancelProcessingCommand}" Margin="6,0,0,0" Padding="10,5" FontSize="11"
                                   Visibility="{Binding IsProcessing, Converter={StaticResource BoolToVisibilityConverter}}" />
                    </StackPanel>
                </Grid>
            </Grid>
        </Border>
    </Grid>
</UserControl>
