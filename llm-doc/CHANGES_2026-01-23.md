# Changes - 2026-01-23

## Bug Fixes

### 1. Processing never starts (MainViewModel.cs)
- **Problem**: `StartProcessingAsync()` silently returned when `OutputArchivePath` was empty (the default), so pressing "Process" did nothing.
- **Fix**: Now prompts the user with a SaveFileDialog when no output path is set.

### 2. Error messages hidden from user (MainViewModel.cs)
- **Problem**: After processing, the status always showed "Processing completed" even when the DLL returned errors.
- **Fix**: Status now shows actual success/failure counts and the first error message from the DLL.

### 3. Settings TextBox text not visible (SettingsView.xaml)
- **Problem**: TextBox Height of 26 was too small, making text entries invisible.
- **Fix**: Increased Height to 30 for TextBox and Button elements.

### 4. Process termination on encoding errors (bpgenc.c, x265_glue.c)
- **Problem**: Multiple `exit(1)` calls in the BPG/x265 encoding path would kill the entire GUI process on any encoding error (memory exhaustion, encoder init failure, HEVC data errors). This caused the "processing 0/47 then stops" behavior.
- **Fix**: Replaced all `exit(1)` calls in the library encoding path with proper error returns (`return -1` or `return NULL`). Errors now propagate up through the FFI layer to C# for display.
- **Files changed**:
  - `BPG/libbpg-0.9.8/bpgenc.c`: `bpg_encoder_encode_trailer()`, `bpg_encoder_encode()`, `image_alloc()`, `bpgenc_encode_from_memory_buffer()` - all exit(1) replaced with error returns
  - `BPG/libbpg-0.9.8/x265_glue.c`: Added null check for `encoder_open()` return value in `x265_open()`
  - `BPG/libbpg-0.9.8/bpg_api.c`: Added error code -5 ("x265 encoding failed") handling

### 5. Unbounded parallelism causing memory exhaustion (orchestrator.rs)
- **Problem**: All images were processed simultaneously via Rayon's default thread pool (one thread per CPU core). With 47 large JPEGs in lossless mode, each spawning a multi-threaded x265 encoder, this exhausted system memory.
- **Fix**: Created a custom Rayon thread pool limited to 5 concurrent encoding tasks.

### 6. Filename collision in parallel encoding (orchestrator.rs)
- **Problem**: BPG output files used only the input filename stem (e.g., `photo.bpg`). If multiple input files shared the same name (from different directories), they would overwrite each other.
- **Fix**: Output filenames now include the work item index (e.g., `photo_3.bpg`), ensuring uniqueness.

## Files Modified

| File | Changes |
|------|---------|
| `DocBrakeGUI/ViewModels/MainViewModel.cs` | SaveFileDialog prompt, error reporting |
| `DocBrakeGUI/Views/SettingsView.xaml` | TextBox/Button height increase |
| `BPG/libbpg-0.9.8/bpgenc.c` | Remove exit(1), add error returns |
| `BPG/libbpg-0.9.8/x265_glue.c` | Null check for encoder_open |
| `BPG/libbpg-0.9.8/bpg_api.c` | Handle error code -5 |
| `openarc-core/src/orchestrator.rs` | Thread pool limit, unique filenames |
